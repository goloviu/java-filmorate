DROP TABLE IF EXISTS friends CASCADE;
DROP TABLE IF EXISTS movie_genre CASCADE;
DROP TABLE IF EXISTS genre CASCADE;
DROP TABLE IF EXISTS movie_like CASCADE;
DROP TABLE IF EXISTS review_like CASCADE;
DROP TABLE IF EXISTS review_dislike CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS director_movies CASCADE;
DROP TABLE IF EXISTS directors CASCADE;
DROP TABLE IF EXISTS movies CASCADE;
DROP TABLE IF EXISTS rating CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS event_types CASCADE;
DROP TABLE IF EXISTS operation CASCADE;
DROP TABLE IF EXISTS feed CASCADE;

CREATE TABLE IF NOT EXISTS users (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name varchar(20),
email varchar(254) NOT NULL UNIQUE,
login varchar(20) NOT NULL UNIQUE,
birthday date NOT NULL
);

CREATE TABLE IF NOT EXISTS rating (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name varchar(10) UNIQUE
);

CREATE TABLE IF NOT EXISTS directors (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS movies (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
title varchar(50) NOT NULL,
description varchar(200) NOT NULL,
duration int4 NOT NULL,
release_date date NOT NULL,
rating_id int4 REFERENCES rating(id)
);

CREATE TABLE IF NOT EXISTS director_movies (
director_id int4 REFERENCES directors(id) ON DELETE CASCADE,
movie_id int4 REFERENCES movies(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS friends (
user_id int4 REFERENCES users(id) ON DELETE CASCADE,
friend_id int4 REFERENCES users(id) ON DELETE CASCADE,
status boolean
);

CREATE TABLE IF NOT EXISTS movie_like (
movie_id int4 REFERENCES movies(id) ON DELETE CASCADE,
user_id int4 REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS genre (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name varchar(30) UNIQUE
);

CREATE TABLE IF NOT EXISTS movie_genre (
movie_id int4 NOT NULL REFERENCES movies(id) ON DELETE CASCADE,
genre_id int4 NOT NULL REFERENCES genre(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS reviews (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
content varchar(200) NOT NULL,
is_positive varchar(5) NOT NULL,
user_id int4 REFERENCES users(id) ON DELETE CASCADE,
movie_id int4 REFERENCES movies(id) ON DELETE CASCADE,
useful INTEGER DEFAULT 0
);

CREATE TABLE IF NOT EXISTS review_like (
review_id int4 REFERENCES reviews(id) ON DELETE CASCADE,
user_id int4 REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS review_dislike (
review_id int4 REFERENCES reviews(id) ON DELETE CASCADE,
user_id int4 REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS event_types (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name varchar(20) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS operation (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name varchar(20) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS feed (
id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
user_id int4 REFERENCES users(id) ON DELETE CASCADE,
event_type_id int4 REFERENCES event_types(id) ON DELETE CASCADE,
operation_id int4 REFERENCES operation(id) ON DELETE CASCADE,
entity_id int4 NOT NULL,
creation_date timestamp NOT NULL DEFAULT(current_timestamp)
);